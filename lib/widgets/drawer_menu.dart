// widgets/drawer_menu.dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:share_plus/share_plus.dart'; // ‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®

import '../utils/data_deletion_manager.dart';
import '../providers/theme_provider.dart';
import '../providers/language_provider.dart';
import '../utils/responsive_utils.dart';
import '../screens/admin_login_screen.dart';
import '../screens/support_screen.dart';
import '../screens/about_contact_page.dart';
import '../screens/reward_screen.dart';
import '../prayer_time_page.dart';
import '../developer_page.dart';

class DrawerMenu extends StatefulWidget {
  final GlobalKey<ScaffoldState> scaffoldKey;

  const DrawerMenu({super.key, required this.scaffoldKey});

  @override
  State<DrawerMenu> createState() => _DrawerMenuState();
}

class _DrawerMenuState extends State<DrawerMenu> {
  bool _showAdminPanel = false;
  DateTime? _pressStartTime;
  bool _isLongPressing = false;

  void _handleAdminAccess() {
    setState(() {
      _showAdminPanel = true;
    });

    // 30 ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶™‡¶∞ ‡¶Ö‡¶ü‡ßã ‡¶π‡¶æ‡¶á‡¶°
    Future.delayed(const Duration(minutes: 30), () {
      if (mounted) {
        setState(() {
          _showAdminPanel = false;
        });
      }
    });
  }

  // ‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
  void _shareApp(BuildContext context) {
    final languageProvider = Provider.of<LanguageProvider>(
      context,
      listen: false,
    );

    final String shareText = languageProvider.isEnglish
        ? "üåü Discover the amazing Islamic Day App! üì±\n\n"
              "‚Ä¢ Learn Quran & Hadith\n"
              "‚Ä¢ Test your Islamic knowledge\n"
              "‚Ä¢ Word by Word Quran learning\n"
              "‚Ä¢ Beautiful Islamic content\n"
              "‚Ä¢ Prayer times & Nearby Mosques\n\n"
              "Download now and enhance your Islamic knowledge! üïå"
        : "üåü ‡¶Ö‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶Ø ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶°‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶°‡¶ø‡¶∏‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®! üì±\n\n"
              "‚Ä¢ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶ì ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏ ‡¶∂‡¶ø‡¶ñ‡ßÅ‡¶®\n"
              "‚Ä¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®\n"
              "‚Ä¢ ‡¶∂‡¶¨‡ßç‡¶¶‡ßá ‡¶∂‡¶¨‡ßç‡¶¶‡ßá ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶∂‡ßá‡¶ñ‡¶æ\n"
              "‚Ä¢ ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü\n"
              "‚Ä¢ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶ì ‡¶ï‡¶æ‡¶õ‡ßá‡¶∞ ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶\n\n"
              "‡¶è‡¶ñ‡¶®‡¶á ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®! üïå";

    Share.share(shareText);
  }

  @override
  Widget build(BuildContext context) {
    final themeProvider = Provider.of<ThemeProvider>(context);
    final languageProvider = Provider.of<LanguageProvider>(context);
    final isDarkMode = themeProvider.isDarkMode;
    final tablet = isTablet(context);

    return GestureDetector(
      onTapDown: (_) {
        _pressStartTime = DateTime.now();
        _isLongPressing = true;
        _startLongPressCheck();
      },
      onTapUp: (_) {
        _isLongPressing = false;
      },
      onTapCancel: () {
        _isLongPressing = false;
      },
      child: Drawer(
        width: tablet ? MediaQuery.of(context).size.width * 0.4 : null,
        backgroundColor: isDarkMode ? Colors.green[900] : Colors.white,
        child: ListView(
          padding: EdgeInsets.zero,
          children: [
            _buildDrawerHeader(context, languageProvider, tablet, isDarkMode),
            _buildDrawerBody(context, languageProvider, themeProvider),
          ],
        ),
      ),
    );
  }

  void _startLongPressCheck() async {
    final startTime = _pressStartTime;
    if (startTime == null) return;

    // 5 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
    await Future.delayed(const Duration(seconds: 5));

    if (_isLongPressing && _pressStartTime == startTime && mounted) {
      _isLongPressing = false;
      _handleAdminAccess();
    }
  }

  Widget _buildDrawerHeader(
    BuildContext context,
    LanguageProvider languageProvider,
    bool tablet,
    bool isDarkMode,
  ) {
    return Container(
      height: responsiveValue(context, tablet ? 120 : 140),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: isDarkMode
              ? [Colors.green[900]!, Colors.green[700]!]
              : [Colors.green[600]!, Colors.green[400]!],
        ),
      ),
      child: Stack(
        children: [
          Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              CircleAvatar(
                radius: responsiveValue(context, tablet ? 25 : 30),
                backgroundColor: Colors.white,
                child: Icon(
                  Icons.menu_book,
                  size: responsiveValue(context, tablet ? 30 : 34),
                  color: Colors.green[800],
                ),
              ),
              const ResponsiveSizedBox(height: 10),

              // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü - ‡¶™‡ßç‡¶Ø‡¶æ‡¶°‡¶ø‡¶Ç ‡¶∏‡¶π
              Padding(
                padding: EdgeInsets.symmetric(
                  horizontal: responsiveValue(context, 16),
                ),
                child: ResponsiveText(
                  languageProvider.isEnglish
                      ? 'Islamic Day - Global Bangladesh'
                      : '‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶°‡ßá - Islamic Day',
                  fontSize: 18, // ‡¶´‡¶®‡ßç‡¶ü ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                  textAlign: TextAlign.center,
                ),
              ),

              const ResponsiveSizedBox(height: 8),

              // ‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü - ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡¶≤‡ßá‡¶ü ‡¶®‡¶æ ‡¶π‡¶≤‡ßá
              if (!tablet)
                Padding(
                  padding: EdgeInsets.symmetric(
                    horizontal: responsiveValue(context, 20),
                  ),
                  child: ResponsiveText(
                    languageProvider.isEnglish
                        ? 'For the Global Bangladeshi Community'
                        : '‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶¨‡ßç‡¶Ø‡¶æ‡¶™‡ßÄ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßÄ ‡¶ï‡¶Æ‡¶ø‡¶â‡¶®‡¶ø‡¶ü‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø',
                    fontSize: 11, // ‡¶´‡¶®‡ßç‡¶ü ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                    color: Colors.white70,
                    textAlign: TextAlign.center,
                  ),
                ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildDrawerBody(
    BuildContext context,
    LanguageProvider languageProvider,
    ThemeProvider themeProvider,
  ) {
    return Column(
      children: [
        // ‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® - ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá
        _buildShareAppItem(context, languageProvider),

        _buildDrawerItem(
          context,
          Icons.mosque,
          languageProvider.isEnglish ? 'Prayer Time' : '‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü',
          const PrayerTimePage(),
        ),

        _buildDrawerItem(
          context,
          Icons.mosque,
          languageProvider.isEnglish ? 'Nearby Mosques' : '‡¶®‡¶ø‡¶ï‡¶ü‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶',
          null,
          url: 'https://www.google.com/maps/search/?api=1&query=‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶',
        ),
        _buildDrawerItem(
          context,
          Icons.person,
          languageProvider.isEnglish ? 'Rewards' : '‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞',
          const RewardScreen(),
        ),
        // drawer_menu.dart - ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®
        _buildDrawerItem(
          context,
          Icons.contact_page, // ‡¶Ö‡¶•‡¶¨‡¶æ Icons.info
          languageProvider.isEnglish ? 'About & Contact' : '‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá',
          const AboutContactPage(), // ‡¶®‡¶§‡ßÅ‡¶® combined page
        ),
        _buildLanguageSwitchItem(context, languageProvider),
        _buildDrawerItem(
          context,
          Icons.volunteer_activism,
          languageProvider.isEnglish ? 'Support Us' : '‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
          const SupportScreen(),
        ),

        _buildDrawerItem(
          context,
          Icons.developer_mode,
          languageProvider.isEnglish ? 'Developer' : '‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶æ‡¶∞',
          DeveloperPage(),
        ),

        // ‚úÖ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡¶Ç ‡¶™‡ßç‡¶∞‡ßá‡¶∏ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
        if (_showAdminPanel) _buildAdminPanelItem(context, languageProvider),

        _buildDrawerItem(
          context,
          Icons.privacy_tip,
          'Privacy Policy',
          null,
          url: 'https://sites.google.com/view/islamicquize/home',
        ),
        _buildDataDeletionItem(context, languageProvider),
        _buildThemeSwitchItem(context, languageProvider, themeProvider),
      ],
    );
  }

  // ‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶¨‡¶ø‡¶≤‡ßç‡¶°‡¶æ‡¶∞
  Widget _buildShareAppItem(
    BuildContext context,
    LanguageProvider languageProvider,
  ) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return ListTile(
      leading: Container(
        padding: EdgeInsets.all(responsiveValue(context, 8)),
        decoration: BoxDecoration(
          color: Colors.blue.withOpacity(0.2),
          borderRadius: BorderRadius.circular(10),
        ),
        child: Icon(
          Icons.share_rounded,
          color: Colors.blue,
          size: responsiveValue(context, 24),
        ),
      ),
      title: ResponsiveText(
        languageProvider.isEnglish ? 'Share App' : '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®',
        fontSize: 16,
        fontWeight: FontWeight.w500,
        color: isDark ? Colors.white : Colors.black87,
      ),
      subtitle: Text(
        languageProvider.isEnglish
            ? 'Share with friends & family'
            : '‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶¨‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®',
        style: TextStyle(
          fontSize: responsiveValue(context, 12),
          color: isDark ? Colors.white60 : Colors.grey[600],
        ),
      ),
      trailing: Icon(
        Icons.arrow_forward_ios,
        size: responsiveValue(context, 16),
        color: isDark ? Colors.white70 : Colors.green[700]!,
      ),
      onTap: () {
        Navigator.pop(context); // Drawer ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
        _shareApp(context); // ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
      },
    );
  }

  // ‚úÖ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ
  Widget _buildAdminPanelItem(
    BuildContext context,
    LanguageProvider languageProvider,
  ) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Column(
      children: [
        Divider(
          color: Colors.green.shade200,
          indent: responsiveValue(context, 16),
          endIndent: responsiveValue(context, 16),
        ),
        ListTile(
          leading: Icon(
            Icons.admin_panel_settings,
            color: Colors.green[700],
            size: responsiveValue(context, 24),
          ),
          title: ResponsiveText(
            languageProvider.isEnglish ? 'Admin Panel' : '‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤',
            fontSize: 16,
            fontWeight: FontWeight.bold,
            //color: Colors.green[700],
          ),
          subtitle: Text(
            'Active for 30 minutes',
            style: TextStyle(fontSize: 12, color: Colors.green[600]),
          ),
          trailing: Icon(
            Icons.arrow_forward_ios,
            size: responsiveValue(context, 16),
            color: isDark ? Colors.white : Colors.green[700]!,
          ),
          onTap: () {
            Navigator.pop(context);
            Navigator.push(
              context,
              MaterialPageRoute(builder: (context) => const AdminLoginScreen()),
            );
          },
        ),
        Divider(
          color: Colors.green.shade200,
          indent: responsiveValue(context, 16),
          endIndent: responsiveValue(context, 16),
        ),
      ],
    );
  }

  // ... ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Æ‡ßá‡¶•‡¶°‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ï‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
  Widget _buildDrawerItem(
    BuildContext context,
    IconData icon,
    String title,
    Widget? page, {
    String? url,
    Function()? onTap,
  }) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return ListTile(
      leading: Icon(
        icon,
        color: isDark ? Colors.white70 : Colors.green[700],
        size: responsiveValue(context, 24),
      ),
      title: ResponsiveText(
        title,
        fontSize: 16,
        fontWeight: FontWeight.w500,
        color: isDark ? Colors.white : Colors.black87,
      ),
      trailing: Icon(
        Icons.arrow_forward_ios,
        size: responsiveValue(context, 16),
        color: isDark ? Colors.white70 : Colors.green[700]!, // ‚úÖ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶°
      ),
      onTap: onTap ?? () => _handleDrawerItemTap(context, page, url),
    );
  }

  void _handleDrawerItemTap(
    BuildContext context,
    Widget? page,
    String? url,
  ) async {
    Navigator.pop(context);
    if (url != null) {
      await _launchUrl(context, url);
    } else if (page != null) {
      Navigator.push(context, MaterialPageRoute(builder: (context) => page));
    }
  }

  Future<void> _launchUrl(BuildContext context, String url) async {
    try {
      final Uri uri = Uri.parse(url);
      if (await canLaunchUrl(uri)) {
        await launchUrl(uri, mode: LaunchMode.externalApplication);
      }
    } catch (e) {
      if (context.mounted) {
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(const SnackBar(content: Text('Could not open link')));
      }
    }
  }

  Widget _buildLanguageSwitchItem(
    BuildContext context,
    LanguageProvider languageProvider,
  ) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return ListTile(
      leading: Icon(
        Icons.language,
        color: isDark ? Colors.white70 : Colors.green[700],
        size: responsiveValue(context, 24),
      ),
      title: ResponsiveText(
        languageProvider.isEnglish ? 'Language' : '‡¶≠‡¶æ‡¶∑‡¶æ',
        fontSize: 16,
        fontWeight: FontWeight.w500,
        color: isDark ? Colors.white : Colors.black87,
      ),
      trailing: Switch(
        value: languageProvider.isEnglish,
        onChanged: (value) => languageProvider.toggleLanguage(),
        activeColor: Colors.green[700],
        activeTrackColor: Colors.green[300],
      ),
    );
  }

  Widget _buildDataDeletionItem(
    BuildContext context,
    LanguageProvider languageProvider,
  ) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return ListTile(
      leading: Icon(
        Icons.delete_forever,
        color: isDark ? Colors.white70 : Colors.green[700],
        size: responsiveValue(context, 24),
      ),
      title: ResponsiveText(
        languageProvider.isEnglish ? 'Delete All Data' : '‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®',
        fontSize: 16,
        fontWeight: FontWeight.w500,
        color: isDark ? Colors.white : Colors.black87,
      ),
      trailing: Icon(
        Icons.arrow_forward_ios,
        size: responsiveValue(context, 16),
        color: Colors.green[700],
      ),
      onTap: () {
        Navigator.pop(context);
        DataDeletionManager.showDeleteDataDialog(context);
      },
    );
  }

  Widget _buildThemeSwitchItem(
    BuildContext context,
    LanguageProvider languageProvider,
    ThemeProvider themeProvider,
  ) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    return Column(
      children: [
        Divider(
          color: Colors.green.shade200,
          indent: responsiveValue(context, 16),
          endIndent: responsiveValue(context, 16),
        ),
        ResponsivePadding(
          horizontal: 12,
          child: Row(
            children: [
              Icon(
                Icons.brightness_6,
                color: isDark ? Colors.white : Colors.green[700]!,
                size: responsiveValue(context, 24),
              ),
              const ResponsiveSizedBox(width: 10),
              ResponsiveText(
                languageProvider.isEnglish ? 'Dark Mode' : '‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶Æ‡ßã‡¶°',
                color: isDark ? Colors.white70 : Colors.green[700]!,
                fontSize: 16,
                fontWeight: FontWeight.w500,
              ),
              const Spacer(),
              Switch(
                value: themeProvider.isDarkMode,
                onChanged: (value) => themeProvider.toggleTheme(value),
                activeColor: Colors.green[700],
                activeTrackColor: Colors.green[300],
              ),
            ],
          ),
        ),
      ],
    );
  }
}
