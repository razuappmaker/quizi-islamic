// screens/premium_screen.dart - UPDATED WITH APP_COLORS
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/language_provider.dart';
import '../../core/managers/premium_manager.dart';
import '../../core/managers/point_manager.dart';
import '../../core/services/in_app_purchase_manager.dart';
import '../../core/constants/app_colors.dart'; // тЬЕ AppColors import

class PremiumScreen extends StatefulWidget {
  const PremiumScreen({Key? key}) : super(key: key);

  @override
  State<PremiumScreen> createState() => _PremiumScreenState();
}

class _PremiumScreenState extends State<PremiumScreen> {
  final PremiumManager _premiumManager = PremiumManager();
  final InAppPurchaseManager _purchaseManager = InAppPurchaseManager();

  bool _isLoading = true;
  bool _isProcessing = false;
  Map<String, dynamic> _premiumStatus = {};
  int _userPoints = 0;
  int _currentTabIndex = 0;

  // Multi-language texts
  final Map<String, Map<String, String>> _texts = {
    'title': {'en': 'Premium Subscription', 'bn': 'ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо рж╕рж╛ржмрж╕рзНржХрзНрж░рж┐ржкрж╢ржи'},
    'premiumExperience': {
      'en': 'Premium Experience',
      'bn': 'ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржПржХрзНрж╕ржкрзЗрж░рж┐рзЯрзЗржирзНрж╕',
    },
    'premiumSubtitle': {
      'en': 'Ad-free + Exclusive features',
      'bn': 'рж╕ржХрж▓ ржЕрзНржпрж╛ржб ржорзБржХрзНржд + ржПржХрзНрж╕ржХрзНрж▓рзБрж╕рж┐ржн ржлрж┐ржЪрж╛рж░',
    },
    'pointsTab': {'en': 'ЁЯОБ Buy with Points', 'bn': 'ЁЯОБ ржкрзЯрзЗржирзНржЯ ржжрж┐рзЯрзЗ ржХрж┐ржирзБржи'},
    'moneyTab': {'en': 'ЁЯТ│ Buy with Money', 'bn': 'ЁЯТ│ ржЯрж╛ржХрж╛ ржжрж┐рзЯрзЗ ржХрж┐ржирзБржи'},
    'yourPoints': {'en': 'Your Points', 'bn': 'ржЖржкржирж╛рж░ ржкрзЯрзЗржирзНржЯ'},
    'points': {'en': 'Points', 'bn': 'ржкрзЯрзЗржирзНржЯ'},
    'monthlyPremium': {'en': 'Monthly Premium', 'bn': 'ржорж╛рж╕рж┐ржХ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо'},
    'yearlyPremium': {'en': 'Yearly Premium', 'bn': 'ржмрж╛рж░рзНрж╖рж┐ржХ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо'},
    'bestOffer': {'en': 'Best Offer', 'bn': 'рж╕рзЗрж░рж╛ ржЕржлрж╛рж░'},
    'buyNow': {'en': 'Buy Now', 'bn': 'ржПржЦржиржЗ ржХрж┐ржирзБржи'},
    'freeTrial': {
      'en': '7-day free trial, then',
      'bn': 'рзн ржжрж┐ржи ржлрзНрж░рж┐ ржЯрзНрж░рж╛рзЯрж╛рж▓, рждрж╛рж░ржкрж░',
    },
    'buyWithPoints': {'en': 'Buy with Points', 'bn': 'ржкрзЯрзЗржирзНржЯ ржжрж┐рзЯрзЗ ржХрж┐ржирзБржи'},
    'notEnoughPoints': {'en': 'Not Enough Points', 'bn': 'ржкрзЯрзЗржирзНржЯ ржирзЗржЗ'},
    'pointsRequired': {'en': 'points required', 'bn': 'ржкрзЯрзЗржирзНржЯ ржкрзНрж░рзЯрзЛржЬржи'},
    'premiumFeatures': {
      'en': 'Premium Features:',
      'bn': 'ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржлрж┐ржЪрж╛рж░рж╕ржорзВрж╣:',
    },
    'adFree': {'en': 'ЁЯЪл All Ads Removed', 'bn': 'ЁЯЪл рж╕ржХрж▓ ржЕрзНржпрж╛ржб ржорзБржХрзНржд'},
    'unlimitedQuizzes': {
      'en': 'ЁЯОп Unlimited Quiz Access',
      'bn': 'ЁЯОп ржЖржирж▓рж┐ржорж┐ржЯрзЗржб ржХрзБржЗржЬ ржПржХрзНрж╕рзЗрж╕',
    },
    'premiumContent': {
      'en': 'ЁЯУЪ Exclusive Premium Content',
      'bn': 'ЁЯУЪ ржПржХрзНрж╕ржХрзНрж▓рзБрж╕рж┐ржн ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржХржирзНржЯрзЗржирзНржЯ',
    },
    'prioritySupport': {
      'en': 'тЪб Priority Support',
      'bn': 'тЪб ржкрзНрж░рж╛рзЯрзЛрж░рж┐ржЯрж┐ рж╕рж╛ржкрзЛрж░рзНржЯ',
    },
    'specialBadge': {
      'en': 'ЁЯТО Special Badge & Status',
      'bn': 'ЁЯТО ржмрж┐рж╢рзЗрж╖ ржмрзНржпрж╛ржЬ ржУ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕',
    },
    'detailedAnalytics': {
      'en': 'ЁЯУК Detailed Analytics',
      'bn': 'ЁЯУК ржбрж┐ржЯрзЗржЗрж▓ржб ржПржирж╛рж▓рж┐ржЯрж┐ржХрзНрж╕',
    },
    'customThemes': {'en': 'ЁЯОи Custom Themes & UI', 'bn': 'ЁЯОи ржХрж╛рж╕рзНржЯржо ржерж┐ржо ржУ UI'},
    'advancedNotifications': {
      'en': 'ЁЯФФ Advanced Notifications',
      'bn': 'ЁЯФФ ржЕрзНржпрж╛ржбржнрж╛ржирзНрж╕ржб ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржи',
    },
    'premiumUser': {
      'en': 'You are Premium User! ЁЯОЙ',
      'bn': 'ржЖржкржирж┐ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржЗржЙржЬрж╛рж░! ЁЯОЙ',
    },
    'purchasedWithPoints': {
      'en': 'ЁЯОБ Purchased with Points',
      'bn': 'ЁЯОБ ржкрзЯрзЗржирзНржЯ ржжрж┐рзЯрзЗ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржирзЗрзЯрж╛ рж╣рзЯрзЗржЫрзЗ',
    },
    'purchasedWithMoney': {
      'en': 'ЁЯТ│ Purchased with Money',
      'bn': 'ЁЯТ│ ржЯрж╛ржХрж╛ ржжрж┐рзЯрзЗ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржирзЗрзЯрж╛ рж╣рзЯрзЗржЫрзЗ',
    },
    'yourPremiumFeatures': {
      'en': 'Your Premium Features:',
      'bn': 'ржЖржкржирж╛рж░ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржлрж┐ржЪрж╛рж░рж╕ржорзВрж╣:',
    },
    'subscriptionStatus': {
      'en': 'Your Subscription Status',
      'bn': 'ржЖржкржирж╛рж░ рж╕рж╛ржмрж╕рзНржХрзНрж░рж┐ржкрж╢ржи рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕',
    },
    'expiryDate': {'en': 'Expiry Date', 'bn': 'ржорзЗрзЯрж╛ржж рж╢рзЗрж╖'},
    'daysRemaining': {'en': 'Days Remaining', 'bn': 'ржмрж╛ржХрж┐ ржжрж┐ржи'},
    'days': {'en': 'days', 'bn': 'ржжрж┐ржи'},
    'comingSoon': {'en': 'Coming Soon', 'bn': 'рж╢рзАржШрзНрж░ржЗ ржЖрж╕ржЫрзЗ'},
    'premiumServiceSoon': {
      'en': 'Premium Service Coming Soon!',
      'bn': 'ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо рж╕рзЗржмрж╛ рж╢рзАржШрзНрж░ржЗ ржЪрж╛рж▓рзБ рж╣ржЪрзНржЫрзЗ!',
    },
    'serviceDescription': {
      'en':
          'We will launch in-app purchase system soon. Meanwhile you can get premium with points.',
      'bn':
          'ржЖржорж░рж╛ ржЦрзБржм рж╢рзАржШрзНрж░ржЗ ржЗржи-ржЕрзНржпрж╛ржк ржкрж╛рж░ржЪрзЗржЬ рж╕рж┐рж╕рзНржЯрзЗржо ржЪрж╛рж▓рзБ ржХрж░ржмред ржПрж░ ржоржзрзНржпрзЗ ржЖржкржирж┐ ржкрзЯрзЗржирзНржЯ ржжрж┐рзЯрзЗ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржкрзЗрждрзЗ ржкрж╛рж░рзЗржиред',
    },
    'activateSuccess': {
      'en': 'тЬЕ Premium activated successfully!',
      'bn': 'тЬЕ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо рж╕ржХрзНрж░рж┐рзЯ рж╣рзЯрзЗржЫрзЗ!',
    },
    'restartApp': {
      'en': 'Please restart the app',
      'bn': 'ржЕрзНржпрж╛ржк рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯ ржХрж░рзБржи',
    },
    'productNotAvailable': {
      'en': 'тЭМ This product is not available',
      'bn': 'тЭМ ржПржЗ ржкрзНрж░рзЛржбрж╛ржХрзНржЯржЯрж┐ ржПржЦржи available ржирзЯ',
    },
    'purchaseIncomplete': {
      'en': 'тЭМ Purchase not completed, please try again',
      'bn': 'тЭМ ржкрж╛рж░ржЪрзЗржЬ рж╕ржорзНржкрзВрж░рзНржг рж╣рзЯржирж┐, ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржи',
    },
    'purchaseFailed': {'en': 'тЭМ Purchase failed', 'bn': 'тЭМ ржкрж╛рж░ржЪрзЗржЬ ржмрзНржпрж░рзНрже'},
    'voluntaryNotice': {
      'en': 'VOLUNTARY SUPPORT - NO FEATURES RESTRICTED',
      'bn': 'ржРржЪрзНржЫрж┐ржХ рж╕рж╣рж╛ржпрж╝рждрж╛ - ржХрзЛржирзЛ ржлрж┐ржЪрж╛рж░ рж╕рзАржорж╛ржмржжрзНржз ржиржпрж╝',
    },
  };

  @override
  void initState() {
    super.initState();
    _initializePurchaseManager();
    _loadData();
    _setupLanguageProvider();
  }

  void _setupLanguageProvider() {
    final languageProvider = Provider.of<LanguageProvider>(
      context,
      listen: false,
    );
    PremiumManager.setLanguageProvider(languageProvider);
  }

  // Helper method to get text based on current language
  String _text(String key, BuildContext context) {
    final languageProvider = Provider.of<LanguageProvider>(
      context,
      listen: false,
    );
    final langKey = languageProvider.isEnglish ? 'en' : 'bn';
    return _texts[key]?[langKey] ?? key;
  }

  Future<void> _initializePurchaseManager() async {
    await _purchaseManager.initialize();
  }

  Future<void> _loadData() async {
    final status = await _premiumManager.getPremiumStatus();
    final userData = await PointManager.getUserData();

    setState(() {
      _premiumStatus = status;
      _userPoints = userData['pendingPoints'] ?? 0;
      _isLoading = false;
    });
  }

  // ЁЯФе ржкрзЯрзЗржирзНржЯ ржжрж┐рзЯрзЗ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржХрж┐ржирзБржи
  Future<void> _purchaseWithPoints(
    String premiumType,
    BuildContext context,
  ) async {
    if (_isProcessing) return;

    setState(() => _isProcessing = true);

    try {
      final success = await _premiumManager.activatePremiumWithPoints(
        premiumType,
        _userPoints,
      );

      if (success) {
        // ржкрзЯрзЗржирзНржЯ ржХрж╛ржЯрзБржи
        final pointsRequired =
            PremiumManager.getPremiumPointsRequirements()[premiumType]!['points']
                as int;
        await PointManager.deductPoints(pointsRequired);

        // ржбрж╛ржЯрж╛ рж░рж┐рж▓рзЛржб ржХрж░рзБржи
        await _loadData();

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'тЬЕ ${PremiumManager.getPremiumPointsRequirements()[premiumType]!['name']} ${_text('activateSuccess', context)}',
            ),
            backgroundColor: Colors.green,
            duration: Duration(seconds: 3),
          ),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('тЭМ $e'),
          backgroundColor: Colors.red,
          duration: Duration(seconds: 3),
        ),
      );
    } finally {
      setState(() => _isProcessing = false);
    }
  }

  // ЁЯФе ржЯрж╛ржХрж╛ ржжрж┐рзЯрзЗ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржХрж┐ржирзБржи
  Future<void> _purchaseWithMoney(
    String productId,
    BuildContext context,
  ) async {
    if (_isProcessing) return;

    setState(() => _isProcessing = true);

    try {
      if (!_purchaseManager.isProductAvailable(productId)) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(_text('productNotAvailable', context)),
            backgroundColor: Colors.orange,
          ),
        );
        return;
      }

      final success = await _purchaseManager.purchaseProduct(productId);

      if (success) {
        await Future.delayed(const Duration(seconds: 2));
        await _loadData();

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              '${_text('activateSuccess', context)} ${_text('restartApp', context)}',
            ),
            backgroundColor: Colors.green,
            duration: Duration(seconds: 4),
          ),
        );
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(_text('purchaseIncomplete', context)),
            backgroundColor: Colors.red,
          ),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('${_text('purchaseFailed', context)}: $e'),
          backgroundColor: Colors.red,
        ),
      );
    } finally {
      setState(() => _isProcessing = false);
    }
  }

  // ЁЯОи ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржмрзНржпрж╛ржЬ
  Widget _buildPremiumBadge(BuildContext context) {
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            AppColors.getAccentColor('blue', isDarkMode),
            AppColors.getAccentColor('purple', isDarkMode),
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: AppColors.getAccentColor(
              'blue',
              isDarkMode,
            ).withOpacity(0.3),
            blurRadius: 8,
            offset: Offset(0, 4),
          ),
        ],
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(Icons.verified, color: Colors.white, size: 16),
          SizedBox(width: 4),
          Text(
            'Premium',
            style: TextStyle(
              color: Colors.white,
              fontSize: 12,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }

  // ЁЯОи ржлрж┐ржЪрж╛рж░ рж░рзЛ
  Widget _buildFeatureRow(
    String featureKey,
    BuildContext context, {
    bool isHighlighted = false,
  }) {
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        children: [
          Icon(
            Icons.check_circle,
            color: isHighlighted
                ? AppColors.getAccentColor('green', isDarkMode)
                : AppColors.getTextSecondaryColor(isDarkMode),
            size: 20,
          ),
          SizedBox(width: 12),
          Expanded(
            child: Text(
              _text(featureKey, context),
              style: TextStyle(
                fontSize: 15,
                fontWeight: isHighlighted ? FontWeight.w600 : FontWeight.normal,
                color: isHighlighted
                    ? AppColors.getAccentColor('green', isDarkMode)
                    : AppColors.getTextColor(isDarkMode),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ЁЯОи Voluntary Notice Banner
  Widget _buildVoluntaryNotice(BuildContext context) {
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(12),
      margin: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isDarkMode
            ? AppColors.getAccentColor('orange', isDarkMode).withOpacity(0.1)
            : Colors.orange[50],
        border: Border.all(
          color: AppColors.getAccentColor(
            'orange',
            isDarkMode,
          ).withOpacity(0.3),
        ),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Row(
        children: [
          Icon(
            Icons.info_outline,
            color: AppColors.getAccentColor('orange', isDarkMode),
            size: 20,
          ),
          SizedBox(width: 8),
          Expanded(
            child: Text(
              _text('voluntaryNotice', context),
              style: TextStyle(
                color: AppColors.getAccentColor('orange', isDarkMode),
                fontWeight: FontWeight.w600,
                fontSize: 12,
              ),
              textAlign: TextAlign.center,
            ),
          ),
        ],
      ),
    );
  }

  // ЁЯОи ржЯрж╛ржХрж╛ ржжрж┐рзЯрзЗ ржХрзЗржирж╛рж░ ржХрж╛рж░рзНржб - ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржбрж┐ржЬрж╛ржЗржи
  Widget _buildMoneyPurchaseCard(String productId, BuildContext context) {
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;
    final isProductAvailable = _purchaseManager.isProductAvailable(productId);
    final priceConfig = PremiumManager.getPremiumPriceConfig();
    final config = productId == PremiumManager.monthlyPremiumId
        ? priceConfig['monthly']!
        : priceConfig['yearly']!;

    final isYearly = productId == PremiumManager.yearlyPremiumId;
    final isPopular = isYearly;

    final primaryColor = isYearly
        ? AppColors.getAccentColor('orange', isDarkMode)
        : AppColors.getAccentColor('blue', isDarkMode);

    return Card(
      elevation: isPopular ? 6 : 3,
      margin: EdgeInsets.all(8),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: BorderSide(
          color: isPopular
              ? primaryColor
              : AppColors.getBorderColor(isDarkMode),
          width: isPopular ? 2 : 1,
        ),
      ),
      child: Container(
        decoration: BoxDecoration(
          gradient: isPopular
              ? LinearGradient(
                  colors: [
                    primaryColor.withOpacity(0.1),
                    AppColors.getAccentColor(
                      'purple',
                      isDarkMode,
                    ).withOpacity(0.1),
                  ],
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                )
              : LinearGradient(
                  colors: [
                    AppColors.getSurfaceColor(isDarkMode),
                    AppColors.getCardColor(isDarkMode),
                  ],
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                ),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Stack(
          children: [
            // ржкржкрзБрж▓рж╛рж░ ржмрзНржпрж╛ржЬ
            if (isPopular)
              Positioned(
                top: 12,
                right: 12,
                child: Container(
                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 4),
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        AppColors.getAccentColor('orange', isDarkMode),
                        AppColors.getErrorColor(isDarkMode),
                      ],
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                    ),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Text(
                    _text('bestOffer', context),
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),

            Padding(
              padding: EdgeInsets.all(20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // рж╣рзЗржбрж╛рж░
                  Row(
                    children: [
                      Icon(
                        isYearly ? Icons.star : Icons.favorite,
                        color: primaryColor,
                        size: 24,
                      ),
                      SizedBox(width: 8),
                      Text(
                        isYearly
                            ? _text('yearlyPremium', context)
                            : _text('monthlyPremium', context),
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: primaryColor,
                        ),
                      ),
                    ],
                  ),

                  SizedBox(height: 16),

                  // ржкрзНрж░рж╛ржЗрж╕
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        config['price'],
                        style: TextStyle(
                          fontSize: 32,
                          fontWeight: FontWeight.bold,
                          color: primaryColor,
                        ),
                      ),
                      SizedBox(height: 4),
                      Text(
                        '/${config['period']}',
                        style: TextStyle(
                          fontSize: 14,
                          color: AppColors.getTextSecondaryColor(isDarkMode),
                        ),
                      ),
                    ],
                  ),

                  SizedBox(height: 8),

                  // рж╕рзЗржнрж┐ржВрж╕
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: AppColors.getAccentColor(
                        'green',
                        isDarkMode,
                      ).withOpacity(0.2),
                      borderRadius: BorderRadius.circular(6),
                      border: Border.all(
                        color: AppColors.getAccentColor(
                          'green',
                          isDarkMode,
                        ).withOpacity(0.3),
                      ),
                    ),
                    child: Text(
                      config['savings'],
                      style: TextStyle(
                        color: AppColors.getAccentColor('green', isDarkMode),
                        fontSize: 12,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),

                  SizedBox(height: 20),

                  // ржмрж╛ржЯржи
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton(
                      onPressed: isProductAvailable && !_isProcessing
                          ? () => _purchaseWithMoney(productId, context)
                          : null,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: primaryColor,
                        foregroundColor: Colors.white,
                        padding: EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        elevation: 4,
                        shadowColor: primaryColor.withOpacity(0.3),
                      ),
                      child: _isProcessing
                          ? SizedBox(
                              width: 20,
                              height: 20,
                              child: CircularProgressIndicator(
                                strokeWidth: 2,
                                color: Colors.white,
                              ),
                            )
                          : Text(
                              _text('buyNow', context),
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                    ),
                  ),

                  SizedBox(height: 8),

                  // ржлрзНрж░рж┐ ржЯрзНрж░рж╛рзЯрж╛рж▓ ржирзЛржЯ
                  Text(
                    '${_text('freeTrial', context)} ${config['price']}',
                    style: TextStyle(
                      fontSize: 12,
                      color: AppColors.getTextSecondaryColor(isDarkMode),
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // ЁЯОи ржкрзЯрзЗржирзНржЯ ржжрж┐рзЯрзЗ ржХрзЗржирж╛рж░ ржХрж╛рж░рзНржб - ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржбрж┐ржЬрж╛ржЗржи
  Widget _buildPointsPurchaseCard(String premiumType, BuildContext context) {
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;
    final pointsOptions = PremiumManager.getPremiumPointsRequirements();
    final config = pointsOptions[premiumType]!;
    final hasEnoughPoints = _userPoints >= config['points'];
    final isYearly = premiumType == 'yearly';
    final primaryColor = AppColors.getAccentColor('purple', isDarkMode);

    return Card(
      elevation: 3,
      margin: EdgeInsets.all(8),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: [
              primaryColor.withOpacity(0.1),
              AppColors.getAccentColor('blue', isDarkMode).withOpacity(0.1),
            ],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Padding(
          padding: EdgeInsets.all(20),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // рж╣рзЗржбрж╛рж░
              Row(
                children: [
                  Icon(Icons.emoji_events, color: primaryColor, size: 24),
                  SizedBox(width: 8),
                  Text(
                    config['name'],
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: primaryColor,
                    ),
                  ),
                ],
              ),

              SizedBox(height: 16),

              // ржкрзЯрзЗржирзНржЯ
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    '${config['points']} ${_text('points', context)}',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: primaryColor,
                    ),
                  ),
                  SizedBox(height: 4),
                  Text(
                    config['duration'],
                    style: TextStyle(
                      fontSize: 14,
                      color: AppColors.getTextSecondaryColor(isDarkMode),
                    ),
                  ),
                ],
              ),

              SizedBox(height: 8),

              // рж╕рзЗржнрж┐ржВрж╕
              Container(
                padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: AppColors.getAccentColor(
                    'green',
                    isDarkMode,
                  ).withOpacity(0.2),
                  borderRadius: BorderRadius.circular(6),
                  border: Border.all(
                    color: AppColors.getAccentColor(
                      'green',
                      isDarkMode,
                    ).withOpacity(0.3),
                  ),
                ),
                child: Text(
                  config['savings'],
                  style: TextStyle(
                    color: AppColors.getAccentColor('green', isDarkMode),
                    fontSize: 12,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),

              SizedBox(height: 20),

              // ржмрж╛ржЯржи
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: hasEnoughPoints && !_isProcessing
                      ? () => _purchaseWithPoints(premiumType, context)
                      : null,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: primaryColor,
                    foregroundColor: Colors.white,
                    padding: EdgeInsets.symmetric(vertical: 16),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    elevation: 4,
                  ),
                  child: _isProcessing
                      ? SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            color: Colors.white,
                          ),
                        )
                      : Text(
                          hasEnoughPoints
                              ? _text('buyWithPoints', context)
                              : _text('notEnoughPoints', context),
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                ),
              ),

              if (!hasEnoughPoints) ...[
                SizedBox(height: 8),
                Text(
                  '${config['points'] - _userPoints} ${_text('pointsRequired', context)}',
                  style: TextStyle(
                    color: AppColors.getErrorColor(isDarkMode),
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    final isSmallScreen = screenWidth < 380;
    final isTablet = screenWidth > 600;
    final isPremium = _premiumStatus['isPremium'] == true;
    final premiumSource = _premiumStatus['source'] ?? 'none';
    final areProductsAvailable = _purchaseManager.areProductsAvailable;
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Scaffold(
      backgroundColor: AppColors.getBackgroundColor(isDarkMode),
      appBar: AppBar(
        title: Text(
          _text('title', context),
          style: TextStyle(
            fontSize: isSmallScreen
                ? 16
                : isTablet
                ? 20
                : 18,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
        ),
        backgroundColor: AppColors.getAppBarColor(isDarkMode),
        foregroundColor: Colors.white,
        centerTitle: true,
        leading: IconButton(
          icon: Icon(Icons.arrow_back_rounded),
          onPressed: () => Navigator.of(context).pop(),
        ),
        actions: [if (isPremium) _buildPremiumBadge(context)],
      ),
      body: _isLoading
          ? Center(
              child: CircularProgressIndicator(
                color: AppColors.getPrimaryColor(isDarkMode),
              ),
            )
          : isPremium
          ? _buildPremiumUserScreen(premiumSource, screenWidth, context)
          : _buildPurchaseScreen(screenWidth, areProductsAvailable, context),
    );
  }

  Widget _buildPurchaseScreen(
    double screenWidth,
    bool areProductsAvailable,
    BuildContext context,
  ) {
    final isTablet = screenWidth > 600;
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return SafeArea(
      bottom: true,
      child: SingleChildScrollView(
        physics: AlwaysScrollableScrollPhysics(),
        child: ConstrainedBox(
          constraints: BoxConstraints(
            minHeight:
                MediaQuery.of(context).size.height -
                AppBar().preferredSize.height -
                MediaQuery.of(context).padding.top,
          ),
          child: Column(
            children: [
              // Voluntary Notice
              _buildVoluntaryNotice(context),

              // рж╣рзЗржбрж╛рж░ рж╕рзЗржХрж╢ржи
              _buildHeaderSection(context),

              // ржЯрзНржпрж╛ржм ржмрж╛рж░
              _buildTabBar(context),

              // ржХржирзНржЯрзЗржирзНржЯ - ржЯрзНржпрж╛ржм ржнрж┐рждрзНрждрж┐ржХ
              _currentTabIndex == 0
                  ? _buildPointsTab(screenWidth, context)
                  : _buildMoneyTab(screenWidth, areProductsAvailable, context),

              // ржлрж┐ржЪрж╛рж░ рж╕рзЗржХрж╢ржи
              _buildFeaturesSection(context),

              // Bottom padding to ensure content doesn't get hidden
              SizedBox(height: MediaQuery.of(context).padding.bottom + 16),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeaderSection(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final isTablet = screenWidth > 600;
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(isTablet ? 32 : 24),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: AppColors.getBackgroundGradient(isDarkMode),
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
      ),
      child: Column(
        children: [
          Icon(
            Icons.workspace_premium,
            size: isTablet ? 80 : 60,
            color: AppColors.getPrimaryColor(isDarkMode),
          ),
          SizedBox(height: isTablet ? 20 : 16),
          Text(
            _text('premiumExperience', context),
            style: TextStyle(
              fontSize: isTablet ? 32 : 28,
              fontWeight: FontWeight.bold,
              color: AppColors.getTextColor(isDarkMode),
            ),
            textAlign: TextAlign.center,
          ),
          SizedBox(height: isTablet ? 12 : 8),
          Text(
            _text('premiumSubtitle', context),
            style: TextStyle(
              fontSize: isTablet ? 18 : 16,
              color: AppColors.getTextSecondaryColor(isDarkMode),
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildTabBar(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final isTablet = screenWidth > 600;
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Container(
      margin: EdgeInsets.all(isTablet ? 20 : 16),
      decoration: BoxDecoration(
        color: AppColors.getSurfaceColor(isDarkMode),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.getBorderColor(isDarkMode)),
      ),
      child: Row(
        children: [
          Expanded(
            child: TextButton(
              onPressed: () => setState(() => _currentTabIndex = 0),
              style: TextButton.styleFrom(
                backgroundColor: _currentTabIndex == 0
                    ? AppColors.getAccentColor('purple', isDarkMode)
                    : Colors.transparent,
                padding: EdgeInsets.symmetric(vertical: isTablet ? 20 : 16),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
              child: Text(
                _text('pointsTab', context),
                style: TextStyle(
                  color: _currentTabIndex == 0
                      ? Colors.white
                      : AppColors.getTextColor(isDarkMode),
                  fontWeight: FontWeight.bold,
                  fontSize: isTablet ? 16 : 14,
                ),
              ),
            ),
          ),
          Expanded(
            child: TextButton(
              onPressed: () => setState(() => _currentTabIndex = 1),
              style: TextButton.styleFrom(
                backgroundColor: _currentTabIndex == 1
                    ? AppColors.getAccentColor('blue', isDarkMode)
                    : Colors.transparent,
                padding: EdgeInsets.symmetric(vertical: isTablet ? 20 : 16),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
              child: Text(
                _text('moneyTab', context),
                style: TextStyle(
                  color: _currentTabIndex == 1
                      ? Colors.white
                      : AppColors.getTextColor(isDarkMode),
                  fontWeight: FontWeight.bold,
                  fontSize: isTablet ? 16 : 14,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildPointsTab(double screenWidth, BuildContext context) {
    final isTablet = screenWidth > 600;
    final pointsOptions = PremiumManager.getPremiumPointsRequirements();

    return Column(
      children: [
        // ржкрзЯрзЗржирзНржЯ ржЗржиржлрзЛ
        _buildPointsInfo(screenWidth, context),

        // ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржХрж╛рж░рзНржбрж╕ - ржЯрзНржпрж╛ржмрж▓рзЗржЯрзЗрж░ ржЬржирзНржп ржЧрзНрж░рж┐ржб
        if (isTablet)
          Padding(
            padding: EdgeInsets.symmetric(horizontal: 16),
            child: GridView.count(
              crossAxisCount: 2,
              shrinkWrap: true,
              physics: NeverScrollableScrollPhysics(),
              childAspectRatio: 0.8,
              mainAxisSpacing: 16,
              crossAxisSpacing: 16,
              children: pointsOptions.keys.map((premiumType) {
                return _buildPointsPurchaseCard(premiumType, context);
              }).toList(),
            ),
          )
        else
          Column(
            children: pointsOptions.keys.map((premiumType) {
              return _buildPointsPurchaseCard(premiumType, context);
            }).toList(),
          ),
      ],
    );
  }

  Widget _buildPointsInfo(double screenWidth, BuildContext context) {
    final isTablet = screenWidth > 600;
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(isTablet ? 20 : 16),
      margin: EdgeInsets.all(isTablet ? 20 : 16),
      decoration: BoxDecoration(
        color: AppColors.getAccentColor('orange', isDarkMode).withOpacity(0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: AppColors.getAccentColor(
            'orange',
            isDarkMode,
          ).withOpacity(0.3),
        ),
      ),
      child: Row(
        children: [
          Icon(
            Icons.account_balance_wallet,
            color: AppColors.getAccentColor('orange', isDarkMode),
            size: isTablet ? 32 : 24,
          ),
          SizedBox(width: isTablet ? 16 : 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  _text('yourPoints', context),
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    fontSize: isTablet ? 18 : 14,
                    color: AppColors.getTextColor(isDarkMode),
                  ),
                ),
                Text(
                  '$_userPoints ${_text('points', context)}',
                  style: TextStyle(
                    fontSize: isTablet ? 24 : 18,
                    fontWeight: FontWeight.bold,
                    color: AppColors.getAccentColor('orange', isDarkMode),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMoneyTab(
    double screenWidth,
    bool areProductsAvailable,
    BuildContext context,
  ) {
    final isTablet = screenWidth > 600;

    return Column(
      children: [
        if (!areProductsAvailable) _buildComingSoonMessage(context),
        SizedBox(height: isTablet ? 20 : 16),

        // ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо ржХрж╛рж░рзНржбрж╕ - ржЯрзНржпрж╛ржмрж▓рзЗржЯрзЗрж░ ржЬржирзНржп ржЧрзНрж░рж┐ржб
        if (isTablet)
          Padding(
            padding: EdgeInsets.symmetric(horizontal: 16),
            child: GridView.count(
              crossAxisCount: 2,
              shrinkWrap: true,
              physics: NeverScrollableScrollPhysics(),
              childAspectRatio: 0.85,
              mainAxisSpacing: 16,
              crossAxisSpacing: 16,
              children: [
                _buildMoneyPurchaseCard(
                  PremiumManager.monthlyPremiumId,
                  context,
                ),
                _buildMoneyPurchaseCard(
                  PremiumManager.yearlyPremiumId,
                  context,
                ),
              ],
            ),
          )
        else
          Column(
            children: [
              // ржорж╛рж╕рж┐ржХ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо
              _buildMoneyPurchaseCard(PremiumManager.monthlyPremiumId, context),

              // ржмрж╛рж░рзНрж╖рж┐ржХ ржкрзНрж░рж┐ржорж┐рзЯрж╛ржо
              _buildMoneyPurchaseCard(PremiumManager.yearlyPremiumId, context),
            ],
          ),
      ],
    );
  }

  Widget _buildComingSoonMessage(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final isTablet = screenWidth > 600;
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(isTablet ? 20 : 16),
      margin: EdgeInsets.all(isTablet ? 20 : 16),
      decoration: BoxDecoration(
        color: AppColors.getAccentColor('orange', isDarkMode).withOpacity(0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: AppColors.getAccentColor('orange', isDarkMode),
        ),
      ),
      child: Column(
        children: [
          Icon(
            Icons.info,
            color: AppColors.getAccentColor('orange', isDarkMode),
            size: isTablet ? 50 : 40,
          ),
          SizedBox(height: isTablet ? 12 : 8),
          Text(
            _text('premiumServiceSoon', context),
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: AppColors.getAccentColor('orange', isDarkMode),
              fontSize: isTablet ? 20 : 16,
            ),
            textAlign: TextAlign.center,
          ),
          SizedBox(height: isTablet ? 12 : 8),
          Text(
            _text('serviceDescription', context),
            style: TextStyle(
              color: AppColors.getAccentColor('orange', isDarkMode),
              fontSize: isTablet ? 16 : 14,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildFeaturesSection(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final isTablet = screenWidth > 600;
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Container(
      padding: EdgeInsets.all(isTablet ? 32 : 24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            _text('premiumFeatures', context),
            style: TextStyle(
              fontSize: isTablet ? 28 : 24,
              fontWeight: FontWeight.bold,
              color: AppColors.getTextColor(isDarkMode),
            ),
          ),
          SizedBox(height: isTablet ? 20 : 16),
          _buildFeatureRow('adFree', context, isHighlighted: true),
          _buildFeatureRow('unlimitedQuizzes', context, isHighlighted: true),
          _buildFeatureRow('premiumContent', context, isHighlighted: true),
          _buildFeatureRow('prioritySupport', context, isHighlighted: true),
          _buildFeatureRow('specialBadge', context, isHighlighted: true),
          _buildFeatureRow('detailedAnalytics', context),
          _buildFeatureRow('customThemes', context),
          _buildFeatureRow('advancedNotifications', context),
        ],
      ),
    );
  }

  Widget _buildPremiumUserScreen(
    String source,
    double screenWidth,
    BuildContext context,
  ) {
    final isTablet = screenWidth > 600;
    final isLifetime = _premiumStatus['isLifetime'] == true;
    final expiryDate = _premiumStatus['expiryDate'];
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return SafeArea(
      bottom: true,
      child: SingleChildScrollView(
        padding: EdgeInsets.all(isTablet ? 32 : 24),
        child: Column(
          children: [
            Icon(
              Icons.verified_user,
              size: isTablet ? 100 : 80,
              color: AppColors.getAccentColor('green', isDarkMode),
            ),
            SizedBox(height: isTablet ? 20 : 16),
            Text(
              _text('premiumUser', context),
              style: TextStyle(
                fontSize: isTablet ? 32 : 28,
                fontWeight: FontWeight.bold,
                color: AppColors.getAccentColor('green', isDarkMode),
              ),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: isTablet ? 12 : 8),
            Text(
              source == 'points'
                  ? _text('purchasedWithPoints', context)
                  : _text('purchasedWithMoney', context),
              style: TextStyle(
                fontSize: isTablet ? 18 : 16,
                color: AppColors.getTextSecondaryColor(isDarkMode),
              ),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: isTablet ? 40 : 32),

            // ржлрж┐ржЪрж╛рж░рж╕
            Card(
              elevation: 4,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
              child: Container(
                decoration: BoxDecoration(
                  color: AppColors.getCardColor(isDarkMode),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Padding(
                  padding: EdgeInsets.all(isTablet ? 32 : 24),
                  child: Column(
                    children: [
                      Text(
                        _text('yourPremiumFeatures', context),
                        style: TextStyle(
                          fontSize: isTablet ? 24 : 20,
                          fontWeight: FontWeight.bold,
                          color: AppColors.getAccentColor('green', isDarkMode),
                        ),
                      ),
                      SizedBox(height: isTablet ? 20 : 16),
                      _buildFeatureRow('adFree', context, isHighlighted: true),
                      _buildFeatureRow(
                        'unlimitedQuizzes',
                        context,
                        isHighlighted: true,
                      ),
                      _buildFeatureRow(
                        'premiumContent',
                        context,
                        isHighlighted: true,
                      ),
                      _buildFeatureRow(
                        'prioritySupport',
                        context,
                        isHighlighted: true,
                      ),
                    ],
                  ),
                ),
              ),
            ),

            if (!isLifetime && expiryDate != null) ...[
              SizedBox(height: isTablet ? 32 : 24),
              Container(
                padding: EdgeInsets.all(isTablet ? 24 : 20),
                decoration: BoxDecoration(
                  color: AppColors.getAccentColor(
                    'blue',
                    isDarkMode,
                  ).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(
                    color: AppColors.getAccentColor(
                      'blue',
                      isDarkMode,
                    ).withOpacity(0.3),
                  ),
                ),
                child: Column(
                  children: [
                    Text(
                      _text('subscriptionStatus', context),
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: isTablet ? 22 : 18,
                        color: AppColors.getAccentColor('blue', isDarkMode),
                      ),
                    ),
                    SizedBox(height: isTablet ? 16 : 12),
                    Text(
                      '${_text('expiryDate', context)}: ${expiryDate.day}/${expiryDate.month}/${expiryDate.year}',
                      style: TextStyle(
                        fontSize: isTablet ? 18 : 16,
                        color: AppColors.getTextColor(isDarkMode),
                      ),
                    ),
                    SizedBox(height: isTablet ? 12 : 8),
                    Text(
                      '${_text('daysRemaining', context)}: ${_premiumStatus['daysRemaining']} ${_text('days', context)}',
                      style: TextStyle(
                        fontSize: isTablet ? 18 : 16,
                        fontWeight: FontWeight.bold,
                        color: AppColors.getAccentColor('blue', isDarkMode),
                      ),
                    ),
                  ],
                ),
              ),
            ],

            // Bottom padding
            SizedBox(height: MediaQuery.of(context).padding.bottom + 16),
          ],
        ),
      ),
    );
  }

  @override
  void dispose() {
    _purchaseManager.dispose();
    super.dispose();
  }
}
